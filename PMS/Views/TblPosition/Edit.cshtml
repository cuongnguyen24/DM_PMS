@model PMS.Models.TblPosition

@{
    ViewData["Title"] = "Edit";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Styles {
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
    <link rel="stylesheet" href="~/css/tbl-position-forms.css">
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="card-title mb-0">Chỉnh sửa chức vụ</h4>
                        <a href="@Url.Action("Index")" class="btn btn-secondary btn-sm">
                            <i class="fa fa-arrow-left"></i> Quay lại
                        </a>
                    </div>
                    <hr />
                    
                    <form asp-action="Edit" method="post" id="editForm">
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>
                        <div id="customValidationError" class="alert alert-danger" style="display: none;"></div>
                        <input type="hidden" asp-for="Id" />
                        
                        <!-- Row 1: Tên chức vụ và Tên viết tắt -->
                        <div class="row">
                            <div class="col-lg-6 col-md-6 col-sm-12">
                                <div class="form-group mb-3">
                                    <label asp-for="Name" class="control-label font-weight-bold mb-1">
                                        Tên chức vụ <span class="text-danger">*</span>
                                    </label>
                                    <input asp-for="Name" class="form-control" placeholder="Nhập tên chức vụ" required />
                                    <span asp-validation-for="Name" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-lg-6 col-md-6 col-sm-12">
                                <div class="form-group mb-3">
                                    <label asp-for="ShortName" class="control-label font-weight-bold mb-1">Tên viết tắt</label>
                                    <input asp-for="ShortName" class="form-control" placeholder="Nhập tên viết tắt chức vụ" />
                                    <span asp-validation-for="ShortName" class="text-danger"></span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Row 2: Loại đối tượng và Ngày hiệu lực -->
                        <div class="row">
                            <div class="col-lg-6 col-md-6 col-sm-12">
                                <div class="form-group mb-3">
                                    <label asp-for="TypeObject" class="control-label font-weight-bold mb-2">
                                        Loại đối tượng <span class="text-danger">*</span>
                                    </label>
                                    <div class="d-flex align-items-center">
                                        <div class="form-check mr-4">
                                            <input class="form-check-input" type="radio" asp-for="TypeObject" value="1" id="typeManager">
                                            <label class="form-check-label" for="typeManager">
                                                Nhà quản lý
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" asp-for="TypeObject" value="2" id="typeEmployee">
                                            <label class="form-check-label" for="typeEmployee">
                                                Người lao động
                                            </label>
                                        </div>
                                    </div>
                                    <span asp-validation-for="TypeObject" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-lg-6 col-md-6 col-sm-12">
                                <div class="form-group mb-3">
                                    <label asp-for="DateIssued" class="control-label font-weight-bold mb-1">
                                        Ngày hiệu lực <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <input class="form-control" type="text" id="dateIssued" readonly 
                                               value="@Model.DateIssued.ToString("dd/MM/yyyy")" />
                                        <div class="input-group-append">
                                            <span class="input-group-text">
                                                <i class="fa fa-calendar"></i>
                                            </span>
                                        </div>
                                    </div>
                                    <input type="hidden" name="DateIssued" value="@Model.DateIssued.ToString("yyyy-MM-ddTHH:mm:ss")" id="dateIssuedHidden" />
                                    <span asp-validation-for="DateIssued" class="text-danger"></span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Row 3: Các hệ số -->
                        <div class="row">
                            <div class="col-lg-4 col-md-4 col-sm-12">
                                <div class="form-group mb-3">
                                    <label class="control-label font-weight-bold mb-1">
                                        Hệ số cơ bản chức vụ
                                    </label>
                                    <input name="BasicPosiontConfficient" class="form-control" type="number" step="0.01" 
                                           value="@(Model.BasicPosiontConfficient.HasValue ? Model.BasicPosiontConfficient.Value.ToString("0.##", System.Globalization.CultureInfo.InvariantCulture) : "")" />
                                    <span asp-validation-for="BasicPosiontConfficient" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-lg-4 col-md-4 col-sm-12">
                                <div class="form-group mb-3">
                                    <label class="control-label font-weight-bold mb-1">
                                        Hệ số chức vụ
                                    </label>
                                    <input name="PosiontConfficient" class="form-control" type="number" step="0.01" 
                                           value="@(Model.PosiontConfficient.HasValue ? Model.PosiontConfficient.Value.ToString("0.##", System.Globalization.CultureInfo.InvariantCulture) : "")" />
                                    <span asp-validation-for="PosiontConfficient" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-lg-4 col-md-4 col-sm-12">
                                <div class="form-group mb-3">
                                    <label class="control-label font-weight-bold mb-1">
                                        Hệ số trách nhiệm
                                    </label>
                                    <input name="ResponsibilityCoefficient" class="form-control" type="number" step="0.01" 
                                           value="@(Model.ResponsibilityCoefficient.HasValue ? Model.ResponsibilityCoefficient.Value.ToString("0.##", System.Globalization.CultureInfo.InvariantCulture) : "")" />
                                    <span asp-validation-for="ResponsibilityCoefficient" class="text-danger"></span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Row 4: Mô tả và Ghi chú -->
                        <div class="row">
                            <div class="col-lg-6 col-md-6 col-sm-12">
                                <div class="form-group mb-3">
                                    <label asp-for="Description" class="control-label font-weight-bold mb-1">Mô tả</label>
                                    <textarea asp-for="Description" class="form-control" rows="3" placeholder="Thông tin mô tả"></textarea>
                                    <span asp-validation-for="Description" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-lg-6 col-md-6 col-sm-12">
                                <div class="form-group mb-3">
                                    <label asp-for="Note" class="control-label font-weight-bold mb-1">Ghi chú</label>
                                    <textarea asp-for="Note" class="form-control" rows="3" placeholder="Nội dung ghi chú"></textarea>
                                    <span asp-validation-for="Note" class="text-danger"></span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Row 5: Trạng thái -->
                        <div class="row">
                            <div class="col-lg-6 col-md-6 col-sm-12">
                                <div class="form-group mb-3">
                                    <label asp-for="Status" class="control-label font-weight-bold mb-1">
                                        Trạng thái <span class="text-danger">*</span>
                                    </label>
                                    <select asp-for="Status" class="form-control">
                                        <option value="1">Hoạt động</option>
                                        <option value="0">Hết hiệu lực</option>
                                    </select>
                                    <span asp-validation-for="Status" class="text-danger"></span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Row 6: Buttons -->
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="form-group text-center">
                                    <button type="submit" class="btn btn-primary btn-lg mr-2">
                                        <i class="fa fa-save"></i> Cập nhật
                                    </button>
                                    <a asp-action="Index" class="btn btn-success btn-lg">
                                        <i class="fa fa-arrow-left"></i> Quay lại
                                    </a>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/locales/bootstrap-datepicker.vi.min.js"></script>
    <script>
        $(document).ready(function () {
            // Initialize date picker
            $('#dateIssued').datepicker({
                format: 'dd/mm/yyyy',
                autoclose: true,
                todayHighlight: true,
                language: 'vi'
            }).on('changeDate', function(e) {
                // Update hidden field with proper ISO format when date changes
                var selectedDate = e.date;
                var isoString = selectedDate.toISOString();
                $('#dateIssuedHidden').val(isoString);
            });
            
            // Calendar icon click event
            $('.input-group-text').click(function() {
                $('#dateIssued').focus();
            });
            
            // Fix decimal input formatting
            $('input[type="number"]').on('input', function() {
                var value = $(this).val();
                // Replace comma with dot for decimal separator
                if (value.includes(',')) {
                    $(this).val(value.replace(',', '.'));
                }
            });
            
            // Function to check if position exists (excluding current record)
            function checkPositionExists(positionName, isFormSubmit) {
                var isValid = true;
                var currentId = $('#Id').val();
                
                $.ajax({
                    url: '@Url.Action("CheckPositionExists", "TblPosition")',
                    type: 'POST',
                    data: { 
                        positionName: positionName,
                        excludeId: currentId,
                        __RequestVerificationToken: $('[name=__RequestVerificationToken]').val()
                    },
                    async: false,
                    beforeSend: function() {
                        console.log('Checking position exists:', positionName, 'excluding ID:', currentId);
                    },
                    success: function(result) {
                        console.log('Check result:', result);
                        if (result.exists && result.isActive) {
                            var errorMsg = 'Chức vụ "' + positionName + '" đã tồn tại và đang hoạt động. Vui lòng đặt tên chức vụ khác hoặc hết hiệu lực chức vụ hiện tại trước!';
                            $('#customValidationError').html(errorMsg).show();
                            if (isFormSubmit) {
                                $('#Name').focus();
                            }
                            isValid = false;
                        } else {
                            $('#customValidationError').hide();
                            isValid = true;
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('AJAX Error:', error);
                        console.error('Status:', status);
                        console.error('Response:', xhr.responseText);
                        if (isFormSubmit) {
                            alert('Có lỗi xảy ra khi kiểm tra chức vụ. Vui lòng thử lại!');
                        }
                        isValid = false;
                    }
                });
                
                return isValid;
            }
            
            // Real-time validation when typing position name
            $('#Name').on('blur', function() {
                var positionName = $(this).val().trim();
                if (positionName !== '') {
                    checkPositionExists(positionName, false);
                }
            });
            
            // Form validation
            $('#editForm').on('submit', function(e) {
                var positionName = $('#Name').val().trim();
                
                if (positionName === '') {
                    alert('Vui lòng nhập tên chức vụ!');
                    e.preventDefault();
                    return false;
                }
                
                // Check validation (exclude current record)
                var isValidationPassed = checkPositionExists(positionName, true);
                
                if (!isValidationPassed) {
                    e.preventDefault();
                    return false;
                }
                
                return true;
            });
        });
    </script>
}
